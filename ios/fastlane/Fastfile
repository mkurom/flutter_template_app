
default_platform(:ios)

platform :ios do
  desc "Description of what the lane does"

  def flutter_version
    data = YAML.load_file('../pubspec.yaml')
    build_name, build_number = data['version'].split('+')
    { name: build_name, number: build_number }
  end

  lane :beta do
    # è¨¼æ˜æ›¸ã€ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆã€åŒæœŸ
		# ENV['CI'] ã¯ GitHub Actions ã§å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤å®šã™ã‚‹ãŸã‚ã®ç’°å¢ƒå¤‰æ•°
    sync_code_signing(
      type: "appstore",
      readonly: ENV['CI'] == 'true'
    )

    # Flutter ã®ãƒ“ãƒ«ãƒ‰
    Dir.chdir('..') do
      sh "flutter", "build", "ios", "--release", "--no-codesign"
    end
		
    # fastlane ã®ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’ä¸Šæ›¸ã
    next_build = flutter_version
    increment_version_number(version_number: next_build[:name])
    increment_build_number(build_number: next_build[:number])

    # Xcode ã®ãƒ“ãƒ«ãƒ‰
    build_app(
      workspace: "Runner.xcworkspace",
      scheme: "Runner",
      export_method: "app-store",
      clean: true,
      silent: true,
      export_options: {
        provisioningProfiles: {
          "com.my.flutterTemplateApp" => "match AppStore com.my.flutterTemplateApp"
        }
      }
    )
    
		# ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    upload_to_testflight(
			skip_waiting_for_build_processing: true
    )

    # 
    clean_build_artifacts

    UI.success("ğŸ‰  Build #{next_build} ãŒ TestFlight ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸï¼")
  end
end
